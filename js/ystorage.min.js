(function(){window.ystorage||(window.ystorage=function(){var g=[],e={};Object.defineProperty(e,"getItem",{value:function(d){return d?this[d]:null},writable:!1,configurable:!1,enumerable:!1});Object.defineProperty(e,"key",{value:function(d){return g[d]},writable:!1,configurable:!1,enumerable:!1});Object.defineProperty(e,"setItem",{value:function(d,c){d&&(document.cookie=escape(d)+"="+escape(c)+"; expires=Tue, 19 Jan 2038 03:14:07 GMT; path=/")},writable:!1,configurable:!1,enumerable:!1});Object.defineProperty(e,
"length",{get:function(){return g.length},configurable:!1,enumerable:!1});Object.defineProperty(e,"removeItem",{value:function(d){d&&(document.cookie=escape(d)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/")},writable:!1,configurable:!1,enumerable:!1});this.get=function(){var d,c;for(c in e)d=g.indexOf(c),-1===d?e.setItem(c,e[c]):g.splice(d,1),delete e[c];for(;0<g.length;g.splice(0,1))e.removeItem(g[0]);for(var a=0,b=document.cookie.split(/\s*;\s*/);a<b.length;a++)d=b[a].split(/\s*=\s*/),1<d.length&&
(e[c=unescape(d[0])]=unescape(d[1]),g.push(c));return e};this.configurable=!1;this.enumerable=!0}());window.ySingleDb||(console.log("Creating ySingleDb ... "),window.ySingleDb=function(g,e){var d={_list:null,toBinArray:function(c){for(var a=(c||"").length,b=new Uint8Array(a),d=0;d<a;d++)b[d]=c.charCodeAt(d);return b},toBinString:function(c){c=new Uint8Array(c);for(var a=[],b=0;65535*b<c.length;b++)a.push(String.fromCharCode.apply(null,c.subarray(65535*b,65535*(b+1))));return a.join("")},setItem:function(c,
a){c=String(c);a._id=a._id||generateUUID();a._ts_update=(new Date).getTime()/1E3;if(a._linked){for(var b=0;b<a._linked.length;b++)delete a[a._linked[b]];delete a._linked}for(var f in a)a.hasOwnProperty(f)&&"_"!=f.substr(0,1)&&isArray(a[f])&&(a[f]=JSON.stringify(a[f]));localStorage.setItem(d._dbTag_+"_item_"+c,JSON.stringify(a));-1==d._list.indexOf(c)&&(d._list[d._list.length]=c,localStorage.setItem(d._dbTag_+"_list",JSON.stringify(d._list)))},setBinItem:function(c,a){d.setItem(c,d.toBinString(a))},
getItem:function(c){c=String(c);c=localStorage.getItem(d._dbTag_+"_item_"+c);c=JSON.parse(c||"{}");if(!isEmpty(c)&&isArray(d._siblingDB)){var a;c._linked=[];for(var b=0;b<d._siblingDB.length;b++){a=d._siblingDB[b].db.getItem(c[d._siblingDB[b].linkage]);for(var f in a)c._linked=[],a.hasOwnProperty(f)&&"undefined"==typeof c[f]&&(c[f]=a[f],c._linked.push(f))}}return c},getBinItem:function(c){return d.toBinArray(d.getItem(c))},getList:function(){return d._list||[]},linkTo:function(c,a){c&&c.getItem?"undefined"==
typeof a&&(c=null):c=a=null;if(c){var b={db:c,linkage:a||null};d._siblingDB=d._siblingDB||[];d._siblingDB.push(b)}},filter:function(c,a,b){if("function"==typeof c){b=yLexObj(b||!0);b.parse();var f,h=d.getList(),e,k;for(f=0;f<h.length;f++)e=d.getItem(h[f]),(k=b.solve(e))&&c(e)}"function"==typeof a&&a()},each:function(c,a,b){var f=function(a,b){b=String(b).split(" ");var c=!0,d,f;for(d in b)f=trim(b[d]),c=isNumber(f)&&isNumber(a)?c&&parseFloat(f)===parseFloat(a):c&&0<=(""+a).toUpperCase().indexOf(f.toUpperCase());
return c},h,e=d.getList(),k,l;for(h=0;h<e.length;h++)if("function"==typeof c){k=d.getItem(e[h]);l="undefined"==typeof b;if(!l)if("string"==typeof b)l=f(k[d.cfg.keyName],b);else if("object"==typeof b){l=!0;for(var g in b)b.hasOwnProperty(g)&&(l="undefined"!==typeof k[g]?l&&f(k[g],b[g]):!1)}l&&c(k)}"function"==typeof a&&a()},insertData:function(c){for(var a in c)c.hasOwnProperty(a)&&d.setItem(c[a][d._keyName_],c[a])},count:function(c){var a=0;d.each(function(){a++},null,c);return a},extractData:function(c,
a){var b=[];d.each(function(a){b[b.length]=a},function(){c(b)},a)},fillList:function(c,a,b){a=a||"id";b&&d.cleanList();for(b=0;b<c.length;b++)c[b][a]&&d.setItem(c[b][a],c)},removeItem:function(c,a){if(("undefined"!==typeof a?a:1)&&"function"==typeof d.onremove)d.onremove(d.getItem(c));localStorage.removeItem(d._dbTag_+"_item_"+c);var b=d._list.indexOf(String(c));-1<b&&(d._list.splice(b,1),localStorage.setItem(d._dbTag_+"_list",JSON.stringify(d._list)))},removeItems:function(c,a){a="undefined"!==typeof a?
a:!0;d.extractData(function(b){for(var c in b)b.hasOwnProperty(c)&&d.removeItem(b[c][d._keyName_],a)},c)},eliminateItem:function(c){d.removeItem(c,!1)},eliminateItems:function(c){d.removeItems(c,!1)},cleanList:function(c){c="undefined"!==typeof c?c:!0;var a=[],b=0,f;for(f in d._list)a[b++]=d._list[f];for(b=0;b<a.length;b++)d.removeItem(a[b],c)},blankList:function(){d.cleanList(!1)},init:function(c,a){d._dbTag_=c;d._keyName_=a||"_id";console.log("ystorage: creating "+c);d._list=localStorage.getItem(d._dbTag_+
"_list");"string"==typeof d._list&&(d._list=JSON&&JSON.parse(d._list)||[]);d._list=d._list||[];return d}};return d.init(g,e)},console.log("ystorage ready!"));window.yServerWatcherObj||(window.yServerWatcherObj=function(g){var e={serverReady:function(d,c){var a=(new Date).getTime();ycomm.crave("sync","ping",null,function(b,f,h){200==b?0<parseInt(h.pong||0)&&(b=(new Date).getTime()-a,console.log("Server ready..."),console.log("Wasted time: {0}ms".format(b)),ycomm.wd_interval=4*b,"function"==typeof d&&
d()):"function"==typeof c&&c(b,f)})},init:function(){ycomm.setDataLocation(g);e.serverReady(function(){console.log("Server ready!")});return e}};return e.init()});window.yInfoObj||(window.yInfoObj=function(g,e,d,c){var a={};a.cfg={db:ySingleDb(e,d),garbage:ySingleDb(e+"_garbage",d),dbName:e,keyName:d,dataModified:0,onrecordcount:null,onprogress:null,oncomplete:null};a.onremove=function(b){b._ts_deletion=(new Date).getTime()/1E3;a.cfg.garbage.setItem(b._id,b);a.cfg.dataModified++};a.isbusy=function(){return a.busy};
a.getItem=function(b){return a.cfg.db.getItem(b)};a.setItem=function(b,c){a.cfg.dataModified++;return a.cfg.db.setItem(b,c)};a.removeItem=function(b){return a.cfg.db.removeItem(b)};a.removeItems=function(b){return a.cfg.db.removeItems(b)};a.eliminateItem=function(b){return a.cfg.db.eliminateItem(b)};a.eliminateItems=function(b){return a.cfg.db.eliminateItems(b)};a.cleanList=function(){return a.cfg.db.cleanList()};a.blankList=function(){return a.cfg.db.blankList()};a.linkTo=function(b,c){return a.cfg.db.linkTo(b,
c)};a.filter=function(b,c,d){return a.cfg.db.filter(b,c,d)};a.each=function(b,c,d){return a.cfg.db.each(b,c,d)};a.paint=a.each;a.count=function(b){return a.cfg.db.count(b)};a.extractData=function(b,c){var d=[];a.each(function(a){d[d.length]=a},function(){b(d)},c)};a.insertData=function(b){return a.cfg.db.insertData(b)};a.cleanCondition=function(){a.cfg.condition={}};a.setCondition=function(b){if("string"==typeof b){b=b.match(/\S+/g);var c,d="";for(c=0;c<b.length;c++)isNumber(b[c])||isOperator(b[c])||
(b[c]="%("+b[c]+")"),d+=b[c]+" ";a.cfg.condition={_statement_:d}}else a.cfg.condition=b||{}};a._retrieveFromServer=function(){var b={xq_start:a.cfg.xq_start,xq_collectionName:a.cfg.dbName},c=(new Date).getTime();mergeObject(a.cfg.condition,b);ycomm.crave("sync","getDocumentInSequence",b,function(b,d,e){if(0<e.length){a.cfg.interleave.adjustRestTime(c);for(b=0;b<e.length;b++)if(a.setItem(e[b][a.cfg.keyName],e[b]),"function"==typeof a.cfg.onprogress)a.cfg.onprogress(a.cfg.dbName,e[b],a.cfg.xq_start+
b);a.cfg.xq_start+=e.length;setTimeout(a._retrieveFromServer,a.cfg.interleave.restTime)}else{if("function"==typeof a.cfg.oncomplete)a.cfg.oncomplete(a.cfg.dbName);a.busy=!1}})};a.retrieveFromServer=function(b,c,d){if(a.busy)return console.warn("yInfoObj busy"),!1;a.busy=!0;a.cfg.onrecordcount=b||null;a.cfg.oncomplete=c||null;a.cfg.onprogress=d||null;a.server.serverReady(function(){ycomm.crave("sync","getRecordCount",a.cfg.condition,function(b,c,d){d=d||[];d[0]=d[0]||{};if("function"==typeof a.cfg.onrecordcount)a.cfg.onrecordcount(a.cfg.dbName,
parseInt(d[0].CC||0));a.cfg.xq_start=0;a._retrieveFromServer()})},function(a,b){console.log("Erro {0} ao tentar acessar o servidor: {1}".format(a,b.message))});return!0};a.templatedData=function(b){var c;if(a.cfg.dataTemplateEmpty)c=b;else{c={};for(var d in a.cfg.dataTemplate)a.cfg.dataTemplate.hasOwnProperty(d)&&(c[d]=b[d])}return c};a.sendToServer=function(b,c){if(a.busy)return console.warn("yInfoObj busy"),!1;a.busy=!0;a.cfg.onrecordcount=null;a.cfg.oncomplete=b||null;a.cfg.onprogress=c||null;
var d=0;a.server.serverReady(function(){a.each(function(b){var c=a.templatedData(b);b._ts_upload=(new Date(b)).getTime()/1E3;mergeObject(a.cfg.condition,c);ycomm.crave("sync","setDocument",c,function(b,c,e){if(200==b&&"function"==typeof a.cfg.onprogress)a.cfg.onprogress(a.cfg.dbName,e[0],++d)})},function(){if("function"==typeof a.cfg.oncomplete)a.cfg.oncomplete(a.cfg.dbName);a.busy=!1},a.cfg.condition)},function(a,b){console.log("Erro {0} ao tentar acessar o servidor: {1}".format(a,b.message))});
return!0};a.init=function(b){a.cfg.interleave=yRestTimeControl(500);a.cfg.dataTemplateEmpty="undefined"===typeof b?!0:!1;a.cfg.dataTemplate=b||{};a.cfg.db.onremove=a.onremove;a.server=yServerWatcherObj(g);a.cleanCondition();return a};return a.init(c)})})();
